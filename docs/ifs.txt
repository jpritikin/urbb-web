IFS Simulator - Actions by Context Summary
==========================================

OVERVIEW
--------
The IFS Simulator is an interactive visualization where "parts" (represented as
animated cloud shapes) can be explored through IFS therapy-inspired interactions.
The simulator has two modes: panorama (overview) and foreground (conference room).
See plan.txt for initial specification.


MODES
-----
1. PANORAMA MODE
   - All clouds float on a torus surface with physics simulation
   - Clouds can be clicked to select as a "target" and enter foreground mode
   - High-attention parts can automatically trigger foreground mode and blend in

2. FOREGROUND MODE (Conference Room)
   - Target parts sit at a circular "conference table"
   - A golden star represents Self, sitting at the table
   - Supporting parts (protectors, grievances) appear behind their targets
   - Blended parts overlay the Self star with stretch animations
   - Pie menu appears on cloud click for actions


ACTIONS (via Pie Menu in Foreground Mode)
-----------------------------------------

| Action ID       | Short Name | Available When                     | Effect                                      |
|-----------------|------------|-----------------------------------|---------------------------------------------|
| familiar        | Familiar?  | Target part                       | Records question in history                 |
| first_memories  | Memories   | Target part                       | Reveals the part's age in biography         |
| feel_toward     | Feel       | Target part                       | Shows protectors/grievances as blended parts; shows thought bubble with response |
| job             | Job        | Target or blended part            | Reveals identity; reduces blending by 30%   |
| join_conference | Join       | Supporting part (not blended)     | Adds part as a target at conference table   |
| separate        | Separate   | Blended part                      | Reduces blending degree by 30%              |
| step_back       | Step back  | Target, supporting, or blended    | Removes part from conference (fades to panorama) |


OTHER INTERACTIONS
------------------
- Click cloud in panorama: Select as target, enter foreground mode
- Click cloud in foreground: Opens pie menu for that cloud
- Long press (touch): Toggle selection state
- Space key (foreground): Toggle selection on hovered cloud
- Mode toggle button (üîç/üî≠): Switch between panorama/foreground
- Trace button (üìú): Show state history panel


STATE MANAGEMENT
----------------
- targetCloudIds: Parts at the conference table
- blendedParts: Parts overlaying Self (with blending degree 0-1)
- supportingParts: Parts shown behind targets (protectors, grievances)
- selectedCloudId: Currently selected for highlight/interaction
- trust: Per-part value (0-1), affects appearance (fill color)
- needAttention: Per-part value, triggers automatic blending when high
- biography: Tracks what's revealed (identity, age, relationships, protects)
- dialogues: Per-part text for responses (burdenedProtector, burdenedGrievance, unburdenedJob)


ANIMATION FEATURES
------------------
- Conference table rotation (continuous unless pie menu open)
- Blended parts "grip loss" animation (stretching toward their seat)
- Message bubbles travel between blended parts and targets (grievances)
- Thought bubbles appear for Self responses
- Seat count animations when parts join/leave


RELATIONSHIPS (defined in ifs.ts setup)
---------------------------------------
- Protection: A part protects another (e.g., Inner Critic protects criticized)
- Grievance: A part has grievance toward another (with strength 0-1)


WHAT'S IMPLEMENTED vs POTENTIAL GAPS
------------------------------------

Implemented:
‚úì Basic conference room layout with rotating table
‚úì Pie menu with context-sensitive actions
‚úì Blending/unblending with stretch animations
‚úì Protector and grievance relationships
‚úì Trust and attention mechanics
‚úì Thought bubble responses
‚úì Message bubbles for grievances
‚úì State history trace
‚úì Biography reveal system (identity, age, relationships)

Potentially incomplete or worth expanding:
- Only one scenario defined (Inner Critic + criticized + age-based parts)
- No "unburdening" flow implemented (just dialogue mentions)
- unburdenedJob dialogue defined but not used in responses
- No save/load state (serialization mentioned in CLAUDE.md but not implemented)
- "agreedWaitUntil" field in PartState defined but not used
- No tutorial or guidance for users
- No mobile-specific adaptations beyond touch/long-press
- Carpet renderer exists but purpose unclear (visual decoration?)


FILE REFERENCE
--------------
- src/ifs.ts:1-46 - Entry point, creates clouds and relationships
- src/ifsModel.ts:1-404 - State management (targets, blending, trust, etc.)
- src/ifsView.ts:1-1327 - Visual state, animations, positioning
- src/cloudManager.ts:1-1739 - Main orchestrator, UI, action handling
- src/cloudShape.ts:1-1117 - Cloud rendering and animation
- src/pieMenu.ts:1-249 - Radial action menu
- src/ifsSimulatorEntrance.ts - Entry animation from landing page
- src/ifsExit.ts - Exit handling with unsaved work prompt
