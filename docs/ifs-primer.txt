IFS Simulator Architecture Primer
==================================

Core pattern: Model-View-Controller with act/sync flow.
All state mutations go through cloudManager.act(action, fn), which:
  1. Clones model (for diff)
  2. Runs fn() which mutates model
  3. Calls syncViewWithModel(oldModel) to propagate changes to view
  4. Records action for playback

Key Files
---------
src/cloud/cloudManager.ts        - Orchestrator. Owns model, view, controller, plus
                                   expandDeepenEffect, playbackRecording,
                                   messageOrchestrator, panoramaInputHandler,
                                   panoramaMotion, carpetRenderer, uiManager.
                                   Handles user interaction routing, animation loop,
                                   act/sync flow.
src/simulator/ifsModel.ts        - Pure state. Targets, blended parts, supporting parts,
                                   self-ray, messages, thought bubbles, mode, pending blends,
                                   pendingAction, displacedParts, victoryAchieved,
                                   selfAmplification, conversationEffectiveStances,
                                   conversationTherapistDelta, conversationParticipantIds,
                                   conversationPhases, conversationSpeakerId,
                                   messageIdCounter, onModeChange callback.
                                   All state serializable to JSON.
src/simulator/ifsView.ts         - View state + rendering coordination. Manages per-cloud
                                   animated state (position, opacity, scale, blending degree).
                                   syncWithModel() delegates to: updateSeatAssignments,
                                   updateStarPosition, updateCloudStateTargets, syncSelfRay,
                                   syncThoughtBubbles, syncMode, syncPendingActionBanner,
                                   syncConversation, checkVictoryCondition.
                                   Also handles displaced part spiral exits with delayed
                                   target arrivals.
src/simulator/simulatorController.ts - Action validation (getValidActions) and execution
                                   (executeAction). Returns ControllerActionResult with
                                   stateChanges, uiFeedback, reduceBlending, triggerBacklash,
                                   createSelfRay, trustGain.
src/simulator/actionEffectApplicator.ts - Applies ControllerActionResult to model: handles
                                   uiFeedback (thought bubbles), reduceBlending, triggerBacklash,
                                   createSelfRay.
src/simulator/actionFormatter.ts - KNOWN_ACTIONS set for validation, action label formatting
                                   for playback, action serialization helpers.
src/simulator/outcomes.ts        - Canonical outcome identifiers (OUTCOMES constant) used by
                                   controller stateChanges. ACTION_OUTCOMES maps actions to
                                   possible outcomes. outcome()/parseOutcome() for
                                   serialization.
src/simulator/therapistActions.ts - Action definitions. Three arrays:
                                   STAR_MENU_ACTIONS (star pie menu),
                                   CLOUD_MENU_ACTIONS (part pie menu),
                                   SELFRAY_MENU_ACTIONS (self-ray pie menu).
src/menu/pieMenu.ts              - Pie menu rendering/UI.
src/menu/pieMenuController.ts    - Routes pie menu interactions to correct action set
                                   based on MenuMode ('cloud' | 'selfRay' | 'star').
                                   Filters to valid actions via controller.getValidActions().
src/simulator/inputHandler.ts    - Cloud click/touch/hover handling, long-press detection.
                                   Checks model for pendingAction; if set, routes click to
                                   cloudManager.completePendingAction() instead of pie menu.
src/simulator/uiManager.ts       - HTML UI elements: mode toggle, mobile banner, trace panel,
                                   debug/pause buttons, recording overlay.
src/simulator/timeAdvancer.ts    - Advances simulation time. Increases needAttention over time,
                                   decays flip odds and therapist stance deltas,
                                   checks attention thresholds, triggers spontaneous blends.
                                   Also runs generic dialogue checks, self-loathing checks,
                                   orchestrator timer updates. Processes in 0.5s interval chunks.
src/simulator/messageOrchestrator.ts - Timed message exchanges between parts, blend-start
                                   delays, cooldown timers (per-sender, generic dialogue,
                                   self-loathing). Grievance and pendulum dialogue responses.
                                   Drives IFIO conversation phase progression: regulation
                                   scoring, phase advancement, stance shock propagation,
                                   listener violation detection, cycle reset logic.
                                   Exports REGULATION_STANCE_LIMIT threshold.
src/simulator/scenarios.ts       - Scenario interface for named test scenarios, session loading.
src/simulator/scenarioSelector.ts - Scenario selection UI/logic with difficulty levels.

Part State
----------
src/cloud/partStateManager.ts    - PartState (individual part data), PartBiography (field
                                   revelation), PartDialogues (conditional responses).
                                   Protection relations, proxy relations, inter-part
                                   trust/stance. InterPartRelation has stanceFlipOdds with
                                   stanceFlipOddsSetPoint (decays back when not in conference).
                                   Conversational dialogue sets with phases
                                   (speak, listen, mirror, validate, empathize).
                                   Fallback dialogues for dominating/withdrawing stances.
                                   getRelation(), getRelationStance(), applyStanceFlip(),
                                   getRelationSummaries() for conversation introspection.
src/star/partState.ts            - Part biography and dialogue definitions.

Visual/Animation
----------------
src/cloud/cloudShape.ts          - SVG cloud rendering, lattice deformation for blending.
src/cloud/cloudAnimation.ts      - Cloud-specific animations.
src/cloud/panoramaCloudMotion.ts - Cloud positions on 3D torus, velocity-based motion.
src/cloud/panoramaInputHandler.ts - Panorama pinch-to-zoom, mouse wheel zoom, drag rotation.
src/cloud/expandDeepenEffect.ts  - Visual effect for expand_deepen action: wavefront
                                   propagation, dot particles, sparkles, selfAmplification boost.
src/star/starAnimation.ts        - Animated star (Self), arm transitions for blended parts.
src/star/starAnimationCore.ts    - Core geometry primitives for star.
src/star/starBorder.ts           - Star border visual (IFIO conversation indicator).
src/star/starFillField.ts        - Star field fill/animation.
src/star/starDebugPanel.ts       - Debug visualization.
src/star/sparkleColors.ts        - Sparkle color generation.
src/star/selfRay.ts              - Beam from star to target part. BiographyField type:
                                   'age'|'identity'|'job'|'jobAppraisal'|'jobImpact'|
                                   'gratitude'|'compassion'.
                                   PartContext interface for conditional field validation.
src/star/carpetRenderer.ts       - Seat carpets for conference table positions. During
                                   conversations, carpets tilt toward/away from partner based
                                   on effective stance. Drag-to-rotate interaction lets
                                   therapist nudge stance (speak/listen). Shows phase labels
                                   and stance values as badges. CarpetState includes tiltAngle.
src/simulator/view/SeatManager.ts - Assigns seats around conference table. Sentinel IDs:
                                   STAR_CLOUD_ID ('*'), RAY_CLOUD_ID ('*ray*'),
                                   MODE_TOGGLE_CLOUD_ID ('*mode*'),
                                   UNBLENDED_SEAT_ID ('__unblended__').
src/simulator/view/TransitionAnimator.ts - Mode transition animations (forward/reverse),
                                   spiral exits for displaced parts, delayed arrivals.
src/simulator/view/MessageRenderer.ts - Renders traveling messages between parts.
src/simulator/view/ThoughtBubbleRenderer.ts - Thought bubble rendering.
src/simulator/view/bubblePlacement.ts - Positioning logic for thought bubbles.
src/simulator/view/StretchAnimator.ts - Stretch animations.
src/simulator/view/HelpPanel.ts  - Help panel UI.
src/simulator/view/VictoryBanner.ts - Victory condition banner.
src/simulator/view/ViewEvents.ts - View event system (ViewEventMap).
src/simulator/view/types.ts      - View-specific types.

Playback/Testing
----------------
src/playback/testability/types.ts - SerializedModel (includes conversationEffectiveStances,
                                   conversationTherapistDelta, conversationParticipantIds,
                                   conversationPhases, conversationSpeakerId,
                                   selfAmplification, mode, victoryAchieved, displacedParts,
                                   thoughtBubbles, orchestrator state, biography snapshots),
                                   ModelSnapshot (includes conversation state + interPartRelations),
                                   RecordedAction, RecordedSession, ControllerActionResult,
                                   Scenario, etc.
src/playback/playbackRecordingCoordinator.ts - Records/replays sessions for testing.
src/playback/playback.ts         - Playback engine. PlaybackSpeed: 'realtime' | 'highlights'
                                   | 'speedrun'.
src/playback/playbackReticle.ts  - Visual reticle for playback.
src/playback/testability/rng.ts  - Seeded RNG. model.random() for reproducibility.
src/playback/testability/headlessSimulator.ts - Headless test runner.
src/playback/testability/monteCarlo.ts - Monte Carlo testing.
src/playback/testability/recorder.ts - Session recording.
src/playback/testability/scenarios.ts - Test scenario infrastructure.

Modes
-----
SimulatorMode: 'panorama' | 'foreground'
- Panorama: all clouds visible on torus, click selects a target (enters foreground).
  Supports pinch-to-zoom, mouse wheel zoom, drag rotation via panoramaInputHandler.
- Foreground: conference table view. Targets sit at seats, blended parts at star center,
  supporting parts orbit their target. Non-participating clouds fade out.
- Transitions animate smoothly (forward/reverse) via TransitionAnimator.
- Clouds move between zoomGroup (panorama coords) and uiGroup (screen coords).

Action Flow
-----------
1. User clicks cloud/star → inputHandler routes based on mode
2. Pie menu shows valid actions (filtered by simulatorController.getValidActions())
3. User selects action → pieMenuController dispatches to cloudManager handler
4. cloudManager calls act(recordedAction, () => {
     result = controller.executeAction(actionId, cloudId, options);
     effectApplicator.apply(result, cloudId);
   })
5. act() then calls syncViewWithModel() to propagate all changes

Internal actions (not user-initiated): ray_field_select, spontaneous_blend, backlash,
mode_change, process_intervals. All tracked via actionFormatter's KNOWN_ACTIONS.

Pending Actions
---------------
Some actions (feel_toward, notice_part, add_target) need a second click to pick a
target. The controller sets model.pendingAction = { actionId, sourceCloudId }.
The view shows a banner (syncPendingActionBanner) with dismiss button.
inputHandler checks model.getPendingAction(); if set, next cloud click calls
cloudManager.completePendingAction(targetCloudId) which dispatches to the
appropriate handler. Cleared on dismiss, mode change to foreground, or completion.

Blending Lifecycle
------------------
spontaneous (needAttention threshold) → partDemandsAttention() → addBlendedPart
  If already a target, removes from targets first then blends.
  If not in conference, displaces existing targets (tracked in displacedParts,
  animated as spiral exits).
  Blended parts' needAttention decays over time (0.98^dt).
therapist-initiated: blend action → removeTargetCloud + addBlendedPart
Separation: separate action → reduceBlending → degree reaches 0 → promoteBlendedToTarget
Pending blends: enqueuePendingBlend → view animates arrival → promotePendingBlend

Conference Participants
-----------------------
model.getConferenceCloudIds() returns union of: targets, blended, pending blends,
supporting parts. All are visible in foreground mode.

Conversation System
-------------------
model.isConversationPossible() checks if two parts can have a directed dialogue.
model.initConversation() applies stance flips, picks initial speaker (highest stance),
sets phases (speaker→speak, listener→listen). Conversation state: participantIds,
speakerId, phases map, effectiveStances cache, therapistDelta map.

Effective stance = relation stance + therapist delta (clamped to [-1,1]).
Therapist deltas decay exponentially. Carpets can be drag-rotated to nudge deltas.

IFIO phase cycle (per speaker): speak/listen → listen/mirror → validate/listen →
listen/empathize → listen/listen (complete). Phases advance when both stances stay
within REGULATION_STANCE_LIMIT (±0.3) long enough for regulationScore > 0.5, and a
phase message was sent. On completion, large trust bonus. Sustained regulation also
grants periodic small trust gains.

Listener violation: if the listening part's stance exceeds REGULATION_STANCE_LIMIT,
the conversation resets with that part as the new speaker.

When both parts are in listen/listen after empathize completes, after NEW_CYCLE_DELAY
the part with highest stance becomes the new speaker and a fresh cycle begins.

Stance shock: when a part speaks, the receiver's stance shifts proportional to
speaker stance magnitude, modulated by self-trust and inter-part trust. Also damages
inter-part trust; overflow beyond zero trust increases needAttention.

MessageType: 'conversation'. Messages travel between parts as PartMessages
rendered by MessageRenderer. Blended parts send dysregulated utterances using
inter-part conversation dialogues.

View tracks conversationParticipantIds via syncConversation(). Star border morphs
to indicate active IFIO conversation. Carpet badges show phase labels and stance.
